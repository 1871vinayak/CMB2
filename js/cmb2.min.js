window.CMB2=function(e,t,i){"use strict";var a=e.cmb2_l10,r=e.setTimeout,n={formfield:"",idNumber:!1,file_frames:{},repeatEls:'input:not([type="button"]),select,textarea,.cmb2-media-status',styleBreakPoint:450,mediaHandlers:{},neweditor_id:[],defaults:{time_picker:a.defaults.time_picker,date_picker:a.defaults.date_picker,color_picker:a.defaults.color_picker||{}}},o=function(e){return i(t.getElementById(e))};return n.metabox=function(){return n.$metabox?n.$metabox:(n.$metabox=i(".cmb2-wrap > .cmb2-metabox"),n.$metabox)},n.init=function(){n.log("CMB2 localized data",a);var t=n.metabox(),l=t.find(".cmb-repeatable-group");n.initPickers(t.find('input[type="text"].cmb2-timepicker'),t.find('input[type="text"].cmb2-datepicker'),t.find('input[type="text"].cmb2-colorpicker')),o("ui-datepicker-div").wrap('<div class="cmb2-element" />'),i('<p><span class="button cmb-multicheck-toggle">'+a.strings.check_toggle+"</span></p>").insertBefore(".cmb2-checkbox-list:not(.no-select-all)"),n.makeListSortable(),t.on("change",".cmb2_upload_file",function(){n.formfield=i(this).attr("id"),o(n.formfield+"_id").val("")}).on("click",".cmb-multicheck-toggle",n.toggleCheckBoxes).on("click",".cmb2-upload-button",n.handleMedia).on("click",".cmb-attach-list li, .cmb2-media-status .img-status img, .cmb2-media-status .file-status > span",n.handleFileClick).on("click",".cmb2-remove-file-button",n.handleRemoveMedia).on("click",".cmb-add-group-row",n.addGroupRow).on("click",".cmb-add-row-button",n.addAjaxRow).on("click",".cmb-remove-group-row",n.removeGroupRow).on("click",".cmb-remove-row-button",n.removeAjaxRow).on("keyup paste focusout",".cmb2-oembed",n.maybeOembed).on("cmb2_remove_row",".cmb-repeatable-group",n.resetTitlesAndIterator).on("click",".cmbhandle, .cmbhandle + .cmbhandle-title",n.toggleHandle),l.length&&l.filter(".sortable").each(function(){i(this).find(".button.cmb-remove-group-row").before('<a class="button cmb-shift-rows move-up alignleft" href="#"><span class="'+a.up_arrow_class+'"></span></a> <a class="button cmb-shift-rows move-down alignleft" href="#"><span class="'+a.down_arrow_class+'"></span></a>')}).on("click",".cmb-shift-rows",n.shiftRows).on("cmb2_add_row",n.emptyValue),r(n.resizeoEmbeds,500),i(e).on("resize",n.resizeoEmbeds)},n.resetTitlesAndIterator=function(){i(".cmb-repeatable-group").each(function(){var e=i(this);e.find(".cmb-repeatable-grouping").each(function(t){var a=i(this);a.data("iterator",t),a.find(".cmb-group-title h4").text(e.find(".cmb-add-group-row").data("grouptitle").replace("{#}",t+1))})})},n.toggleHandle=function(e){e.preventDefault(),i(t).trigger("postbox-toggled",i(this).parent(".postbox").toggleClass("closed"))},n.toggleCheckBoxes=function(e){e.preventDefault();var t=i(this),a=t.closest(".cmb-td").find("input[type=checkbox]");t.data("checked")?(a.prop("checked",!1),t.data("checked",!1)):(a.prop("checked",!0),t.data("checked",!0))},n.handleMedia=function(e){e.preventDefault();var t=i(this);n.attach_id=t.hasClass("cmb2-upload-list")?!1:t.closest(".cmb-td").find(".cmb2-upload-file-id").val(),n.attach_id="0"!==n.attach_id?n.attach_id:!1,n._handleMedia(t.prev("input.cmb2-upload-file").attr("id"),t.hasClass("cmb2-upload-list"))},n.handleFileClick=function(e){e.preventDefault();var t=i(this),a=t.closest(".cmb-td"),r=a.find(".cmb2-upload-button").hasClass("cmb2-upload-list");n.attach_id=r?t.find('input[type="hidden"]').data("id"):a.find(".cmb2-upload-file-id").val(),n.attach_id&&n._handleMedia(a.find("input.cmb2-upload-file").attr("id"),r,n.attach_id)},n._handleMedia=function(e,t){if(wp){var r=n.metabox();n.formfield=e;var l=o(n.formfield),d=l.data("previewsize"),s=l.attr("name"),c=!0,m=!0;if(n.formfield in n.file_frames)return void n.file_frames[n.formfield].open();n.file_frames[n.formfield]=wp.media({title:r.find("label[for="+n.formfield+"]").text(),button:{text:a.strings.upload_file},multiple:t?!0:!1}),n.mediaHandlers.list=function(e,t){m=e.toJSON(),l.val(m.url),o(n.formfield+"_id").val(m.id);var r=[];return i(m).each(function(){if(this.type&&"image"===this.type){var e=d[0]?d[0]:50,t=d[1]?d[1]:50;c='<li class="img-status"><img width="'+e+'" height="'+t+'" src="'+this.url+'" class="attachment-'+e+"px"+t+'px" alt="'+this.filename+'"><p><a href="#" class="cmb2-remove-file-button" rel="'+n.formfield+"["+this.id+']">'+a.strings.remove_image+'</a></p><input type="hidden" id="filelist-'+this.id+'" data-id="'+this.id+'" name="'+s+"["+this.id+']" value="'+this.url+'"></li>'}else c='<li class="file-status"><span>'+a.strings.file+" <strong>"+this.filename+'</strong></span>&nbsp;&nbsp; (<a href="'+this.url+'" target="_blank" rel="external">'+a.strings.download+'</a> / <a href="#" class="cmb2-remove-file-button" rel="'+n.formfield+"["+this.id+']">'+a.strings.remove_file+'</a>)<input type="hidden" id="filelist-'+this.id+'" data-id="'+this.id+'" name="'+s+"["+this.id+']" value="'+this.url+'"></li>';r.push(c)}),t?r:void i(r).each(function(){l.siblings(".cmb2-media-status").slideDown().append(this)})},n.mediaHandlers.single=function(e){if(m=e.first().toJSON(),l.val(m.url),o(n.formfield+"_id").val(m.id),m.type&&"image"===m.type){var t=d[0]?d[0]:350;c='<div class="img-status"><img width="'+t+'px" style="max-width: '+t+'px; width: 100%; height: auto;" src="'+m.url+'" alt="'+m.filename+'" title="'+m.filename+'" /><p><a href="#" class="cmb2-remove-file-button" rel="'+n.formfield+'">'+a.strings.remove_image+"</a></p></div>"}else c='<div class="file-status"><span>'+a.strings.file+" <strong>"+m.filename+'</strong></span>&nbsp;&nbsp; (<a href="'+m.url+'" target="_blank" rel="external">'+a.strings.download+'</a> / <a href="#" class="cmb2-remove-file-button" rel="'+n.formfield+'">'+a.strings.remove_file+"</a>)</div>";l.siblings(".cmb2-media-status").slideDown().html(c)},n.mediaHandlers.selectFile=function(){var e=n.file_frames[n.formfield].state().get("selection"),a=t?"list":"single";return n.attach_id&&t?void i('[data-id="'+n.attach_id+'"]').parents("li").replaceWith(n.mediaHandlers.list(e,!0)):void n.mediaHandlers[a](e)},n.mediaHandlers.openModal=function(){var e=n.file_frames[n.formfield].state().get("selection");if(!n.attach_id)return e.reset();var t=wp.media.attachment(n.attach_id);t.fetch(),e.set(t?[t]:[])},n.file_frames[n.formfield].on("select",n.mediaHandlers.selectFile).on("open",n.mediaHandlers.openModal),n.file_frames[n.formfield].open()}},n.handleRemoveMedia=function(e){e.preventDefault();var t=i(this);return t.is(".cmb-attach-list .cmb2-remove-file-button")?(t.parents("li").remove(),!1):(n.formfield=t.attr("rel"),n.metabox().find("input#"+n.formfield).val(""),n.metabox().find("input#"+n.formfield+"_id").val(""),t.parents(".cmb2-media-status").html(""),!1)},n.cleanRow=function(e,t,a){var r=e.find('input:not([type="button"]), select, textarea, label'),o=e.find("[id]").not('input:not([type="button"]), select, textarea, label');return a&&(e.find(".cmb-repeat-table .cmb-repeat-row:not(:first-child)").remove(),o.length&&o.each(function(){var a=i(this),r=a.attr("id"),o=r.replace("_"+t,"_"+n.idNumber),l=e.find('[data-selector="'+r+'"]');a.attr("id",o),l.length&&l.attr("data-selector",o).data("selector",o)})),n.neweditor_id=[],r.filter(":checked").prop("checked",!1),r.filter(":selected").prop("selected",!1),e.find("h3.cmb-group-title").length&&e.find("h3.cmb-group-title").text(e.data("title").replace("{#}",n.idNumber+1)),r.each(function(){var e,a,r=i(this),o=r.hasClass("wp-editor-area"),l=r.attr("for"),d={};if(l)d={"for":l.replace("_"+t,"_"+n.idNumber)};else{var s=r.attr("name"),c=s?s.replace("["+t+"]","["+n.idNumber+"]"):"";a=r.attr("id"),e=a?a.replace("_"+t,"_"+n.idNumber):"",d={id:e,name:c,"data-iterator":n.idNumber}}if(r.removeClass("hasDatepicker").attr(d).val(""),o){e=e?a.replace("zx"+t,"zx"+n.idNumber):"",r.html("");var m=r.parents(".cmb-type-wysiwyg");m.find(".mce-tinymce:not(:first-child)").remove();var p=m.html().replace(new RegExp(a,"g"),e);m.html(p),n.neweditor_id.push({id:e,old:a})}}),n},n.newRowHousekeeping=function(e){var t=e.find(".wp-picker-container"),a=e.find(".cmb2-media-status");return t.length&&t.each(function(){var e=i(this).parent();e.html(e.find('input[type="text"].cmb2-colorpicker').attr("style",""))}),a.length&&a.empty(),n},n.afterRowInsert=function(e){var t;if(n.neweditor_id.length){var i;for(i=n.neweditor_id.length-1;i>=0;i--){var a=n.neweditor_id[i].id,r=n.neweditor_id[i].old;if("undefined"==typeof tinyMCEPreInit.mceInit[a]){var o=jQuery.extend({},tinyMCEPreInit.mceInit[r]);for(t in o)"string"==typeof o[t]&&(o[t]=o[t].replace(new RegExp(r,"g"),a));tinyMCEPreInit.mceInit[a]=o}if("undefined"==typeof tinyMCEPreInit.qtInit[a]){var l=jQuery.extend({},tinyMCEPreInit.qtInit[r]);for(t in l)"string"==typeof l[t]&&(l[t]=l[t].replace(new RegExp(r,"g"),a));tinyMCEPreInit.qtInit[a]=l}tinyMCE.init({id:tinyMCEPreInit.mceInit[a]})}}n.initPickers(e.find('input[type="text"].cmb2-timepicker'),e.find('input[type="text"].cmb2-datepicker'),e.find('input[type="text"].cmb2-colorpicker'))},n.updateNameAttr=function(){var e=i(this),t=e.attr("name");if("undefined"==typeof t)return!1;var a=parseInt(e.parents(".cmb-repeatable-grouping").data("iterator")),r=a-1,n=t.replace("["+a+"]","["+r+"]");e.attr("name",n)},n.emptyValue=function(e,t){i('input:not([type="button"]), textarea',t).val("")},n.addGroupRow=function(e){e.preventDefault();var t=i(this);t.trigger("cmb2_add_group_row_start",t);var a=o(t.data("selector")),r=a.find(".cmb-repeatable-grouping").last(),l=parseInt(r.data("iterator"));n.idNumber=l+1;var d=r.clone();n.newRowHousekeeping(d.data("title",t.data("grouptitle"))).cleanRow(d,l,!0),d.find(".cmb-add-row-button").prop("disabled",!1);var s=i('<div class="postbox cmb-row cmb-repeatable-grouping" data-iterator="'+n.idNumber+'">'+d.html()+"</div>");r.after(s),n.afterRowInsert(s),a.find(".cmb-repeatable-grouping").length<=1?a.find(".cmb-remove-group-row").prop("disabled",!0):a.find(".cmb-remove-group-row").prop("disabled",!1),a.trigger("cmb2_add_row",s)},n.addAjaxRow=function(e){e.preventDefault();var t=i(this),a=o(t.data("selector")),r=a.find(".empty-row"),l=parseInt(r.find("[data-iterator]").data("iterator"));n.idNumber=l+1;var d=r.clone();n.newRowHousekeeping(d).cleanRow(d,l),r.removeClass("empty-row hidden").addClass("cmb-repeat-row"),r.after(d),n.afterRowInsert(d),a.trigger("cmb2_add_row",d),a.find(".cmb-remove-row-button").removeClass("button-disabled")},n.removeGroupRow=function(e){e.preventDefault();var t=i(this),a=o(t.data("selector")),r=t.parents(".cmb-repeatable-grouping"),l=a.find(".cmb-repeatable-grouping").length;l>1&&(a.trigger("cmb2_remove_group_row_start",t),r.nextAll(".cmb-repeatable-grouping").find(n.repeatEls).each(n.updateNameAttr),r.remove(),2>=l?a.find(".cmb-remove-group-row").prop("disabled",!0):a.find(".cmb-remove-group-row").prop("disabled",!1),a.trigger("cmb2_remove_row"))},n.removeAjaxRow=function(e){e.preventDefault();var t=i(this);if(!t.hasClass("button-disabled")){var a=t.parents(".cmb-row"),r=t.parents(".cmb-repeat-table"),n=r.find(".cmb-row").length;n>2?(a.hasClass("empty-row")&&a.prev().addClass("empty-row").removeClass("cmb-repeat-row"),t.parents(".cmb-repeat-table .cmb-row").remove(),3===n&&r.find(".cmb-remove-row-button").addClass("button-disabled"),r.trigger("cmb2_remove_row")):t.addClass("button-disabled")}},n.shiftRows=function(e){e.preventDefault();var t=i(this);t.trigger("cmb2_shift_rows_enter",t);var a=t.parents(".cmb-repeatable-grouping"),r=t.hasClass("move-up")?a.prev(".cmb-repeatable-grouping"):a.next(".cmb-repeatable-grouping");if(r.length){t.trigger("cmb2_shift_rows_start",t);var o=[];a.find(n.repeatEls).each(function(){var e,t=i(this);e=t.hasClass("cmb2-media-status")?t.html():"checkbox"===t.attr("type")||"radio"===t.attr("type")?t.is(":checked"):"select"===t.prop("tagName")?t.is(":selected"):t.val(),o.push({val:e,$:t})}),r.find(n.repeatEls).each(function(e){var t,a=i(this);a.hasClass("cmb2-media-status")?(t=a.html(),a.html(o[e].val),o[e].$.html(t)):"checkbox"===a.attr("type")||"radio"===a.attr("type")?(o[e].$.prop("checked",a.is(":checked")),a.prop("checked",o[e].val)):"select"===a.prop("tagName")?(o[e].$.prop("selected",a.is(":selected")),a.prop("selected",o[e].val)):(o[e].$.val(a.val()),a.val(o[e].val))}),t.trigger("cmb2_shift_rows_complete",t)}},n.initPickers=function(e,t,i){n.initTimePickers(e),n.initDatePickers(t),n.initColorPickers(i)},n.initTimePickers=function(e){e.length&&(e.timepicker("destroy"),e.timepicker(n.defaults.time_picker))},n.initDatePickers=function(e){e.length&&e.each(function(){var e=n.defaults.date_picker;i(this).datepicker("destroy");var t=i(this).data("datepicker");i.extend(e,t),i(this).datepicker(e)})},n.initColorPickers=function(e){e.length&&("object"==typeof jQuery.wp&&"function"==typeof jQuery.wp.wpColorPicker?e.wpColorPicker(n.defaults.color_picker):e.each(function(e){i(this).after('<div id="picker-'+e+'" style="z-index: 1000; background: #EEE; border: 1px solid #CCC; position: absolute; display: block;"></div>'),o("picker-"+e).hide().farbtastic(i(this))}).focus(function(){i(this).next().show()}).blur(function(){i(this).next().hide()}))},n.makeListSortable=function(){var e=n.metabox().find(".cmb2-media-status.cmb-attach-list");e.length&&e.sortable({cursor:"move"}).disableSelection()},n.maybeOembed=function(e){var t=i(this),a=e.type,o={focusout:function(){r(function(){n.spinner(".postbox .cmb2-metabox",!0)},2e3)},keyup:function(){var i=function(t,i){return e.which<=i&&e.which>=t};(i(48,90)||i(96,111)||i(8,9)||187===e.which||190===e.which)&&n.doAjax(t,e)},paste:function(){r(function(){n.doAjax(t)},100)}};o[a]()},n.resizeoEmbeds=function(){n.metabox().each(function(){var e=i(this),t=e.parents(".inside"),a=e.parents(".inner-sidebar").length||e.parents("#side-sortables").length,r=a,o=!1;if(!t.length)return!0;var l=t.width();n.styleBreakPoint>l&&(r=!0,o=n.styleBreakPoint-62>l),l=r?l:Math.round(.82*t.width()*.97);var d=l-30;if(!r||a||o||(d-=75),d>639)return!0;var s=e.find(".cmb-type-oembed .embed-status"),c=s.children().not(".cmb2-remove-wrapper");return c.length?void c.each(function(){var e=i(this),t=e.width(),a=e.height(),n=d;e.parents(".cmb-repeat-row").length&&!r&&(n=d-91,n=785>l?n-15:n);var o=Math.round(n*a/t);e.width(n).height(o)}):!0})},n.log=function(){a.script_debug&&console&&"function"==typeof console.log&&console.log.apply(console,arguments)},n.spinner=function(e,t){t?i(".cmb-spinner",e).hide():i(".cmb-spinner",e).show()},n.doAjax=function(e){var t=e.val();if(!(t.length<6)){var o=e.attr("id"),l=e.closest(".cmb-td"),d=l.find(".embed-status"),s=l.find(".embed_wrap"),c=d.find(":first-child"),m=d.length&&c.length?c.width():e.width();n.log("oembed_url",t,o),n.spinner(l),s.html(""),r(function(){i(".cmb2-oembed:focus").val()===t&&i.ajax({type:"post",dataType:"json",url:a.ajaxurl,data:{action:"cmb2_oembed_handler",oembed_url:t,oembed_width:m>300?m:300,field_id:o,object_id:e.data("objectid"),object_type:e.data("objecttype"),cmb2_ajax_nonce:a.ajax_nonce},success:function(e){n.log(e),n.spinner(l,!0),s.html(e.data)}})},500)}},i(t).ready(n.init),n}(window,document,jQuery);